<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>List of Storage Manager instances - Kadalu Storage Manager</title>
    <link rel="stylesheet" href="/static/css/stylesheet.css">
    <link rel="stylesheet" href="/static/css/app.css">
    <script src="/static/js/app.js"></script>
    <script defer src="/static/js/alpinejs@3.10.2.js"></script>
  </head>
  <body>
      <div class="columns">
          <div class="column is-2 has-background-primary has-text-white-ter" style="height:100vh">
              <div class="p-5">
                  <img src="/static/logo.png"/>
                  <div class="">
                      A
                  </div>
              </div>
          </div>
          <div class="column is-10">
              <nav class="container px-2 py-1 has-text-right">
                  <div class="dropdown is-hoverable is-right">
                      <div class="dropdown-trigger">
                          <button class="button" aria-haspopup="true" aria-controls="dropdown-menu">
                              <span>Admin</span>
                              <span class="icon is-small">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                  </svg>
                              </span>
                          </button>
                      </div>
                      <div class="dropdown-menu" id="dropdown-menu" role="menu">
                          <div class="dropdown-content">
                              <a href="#" class="dropdown-item">
                                  Logout
                              </a>
                          </div>
                      </div>
                  </div>
              </nav>
              
    <div x-data="data" x-init="getStorageManagers">
        <button class="button is-primary is-clickable mb-6"
                title="Add a new Storage Manager instance"
                @click="show_add_storage_manager = true"
                x-show="show_add_button">
            <span class="icon is-small">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                </svg>
            </span>
            <span>Add</span>
        </button>
        <article class="message is-success" x-show="message != ''">
            <div class="message-body" x-text="message"></div>
        </article>
        <div x-show="storage_managers.length == 0 || show_add_storage_manager" class="mr-5 mb-6">
            <article class="message is-info">
                <div class="message-body">
                    <h3 class="has-text-weight-semibold">Add a new Storage Manager instance.</h3>
                    All instances details are saved in local storage of your browser. The Manager URL added here are not available in other browser instances. API calls to get Storage Pools and Volumes information are initiated from the browser and no information is shared with us.
                </div>
            </article>

            <article class="message is-danger" x-show="error != ''">
                <div class="message-body" x-text="error"></div>
            </article>
            <form @submit.prevent="addInstance">
                <div class="field">
                    <label class="label">Name</label>
                    <div class="control">
                        <input class="input" x-model="sm_name" type="text" placeholder="Dev">
                    </div>
                </div>

                <div class="field">
                    <label class="label">URL</label>
                    <div class="control">
                        <input class="input" x-model="sm_url" type="text" placeholder="http://localhost:3000">
                    </div>
                </div>

                <div class="field is-grouped">
                    <div class="control">
                        <input type="submit" class="button is-link" value="Add"/>
                    </div>
                    <div class="control">
                        <button class="button is-link is-light" @click="show_add_storage_manager = false">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="columns m-2">
            <template x-for="sm in storage_managers">
                <div class="column is-3">
                    <div class="card is-clickable m-2" @click="location.href=poolUrl(pool)">
                        <div class="card-content">
                            <div class="media">
                                <div class="media-left">
                                    <svg xmlns="http://www.w3.org/2000/svg" x-show="sm.reachable" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 icon has-text-success">
                                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.53 5.47a.75.75 0 00-1.06 0l-3 3a.75.75 0 101.06 1.06l1.72-1.72v5.69a.75.75 0 001.5 0v-5.69l1.72 1.72a.75.75 0 101.06-1.06l-3-3z" clip-rule="evenodd" />
                                    </svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" x-show="!sm.reachable" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 icon has-text-danger">
                                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-.53 14.03a.75.75 0 001.06 0l3-3a.75.75 0 10-1.06-1.06l-1.72 1.72V8.25a.75.75 0 00-1.5 0v5.69l-1.72-1.72a.75.75 0 00-1.06 1.06l3 3z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="media-content">
                                    <p class="title is-4" x-text="sm.name" @click="location.href=storageManagerUrl(sm)"></p>
                                    <p class="subtitle is-6" x-text="sm.url" @click="location.href=storageManagerUrl(sm)"></p>
                                </div>
                            </div>
                        </div>
                        <footer class="card-footer">
                            <p class="card-footer-item">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="has-text-danger w-6 h-6 icon is-small is-clickable" @click="deleteInstance(sm.name)">
                                    <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 101.499-.058l-.346-9zm5.48.058a.75.75 0 10-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z" clip-rule="evenodd" />
                                </svg>
                            </p>
                        </footer>
                    </div>
                </div>
            </template>
        </div>

    </div>
    <script>
     var qparams = new URLSearchParams(window.location.search);

     document.addEventListener('alpine:init', () => {
         Alpine.data('data', () => ({
             link_name: "storage_managers",
             show_add_storage_manager: false,
             show_add_button: true,
             sm_name: "",
             sm_url: "",
             error: "",
             message: "",
             storage_managers: [],
             storageManagerUrl(sm) {
                 return '/pools?mgr=' + sm.url;
             },
             storageManagerStatus(idx) {
                 fetch(this.storage_managers[idx].url + '/ping')
                     .then((response) => {
                         if (response.status === 200) {
                             this.storage_managers[idx].reachable = true;
                         } else {
                             this.storage_managers[idx].reachable = false;
                         }
                     });
             },
             getStorageManagers() {
                 var instances = window.localStorage.getItem("storage_managers");
                 if (!instances) {
                     this.storage_managers = [];
                     this.show_add_button = false;
                     return;
                 }

                 this.storage_managers = JSON.parse(instances);
                 for (var i=0; i<this.storage_managers.length; i++) {
                     this.storageManagerStatus(i);
                 }
                 if (this.storage_managers.length === 0) {
                     this.show_add_button = false;
                 }
             },
             addInstance() {
                 var obj = this;
                 if (obj.sm_name == "") {
                     obj.error = "Invalid instance name";
                     return
                 }
                 if (obj.sm_url == "") {
                     obj.error = "Invalid instance URL";
                     return
                 }
                 try {
                     var url = new URL(obj.sm_url);
                     obj.sm_url = url.protocol + "//" + url.host;
                 } catch (error) {
                     obj.error = "Invalid instance URL";
                     return;
                 }

                 for (var i=0; i<obj.storage_managers.length; i++) {
                     if (obj.storage_managers[i].name.toLowerCase() === obj.sm_name.toLowerCase()) {
                         obj.error = "Storage Manager Name already exists"
                         return
                     }
                     if (obj.storage_managers[i].url.toLowerCase() === obj.sm_url.toLowerCase()) {
                         obj.error = "Storage Manager URL already exists"
                         return
                     }
                 }
                 obj.error = "";
                 var instances = window.localStorage.getItem("storage_managers");
                 if (!instances) instances = "[]";
                 var data = JSON.parse(instances);
                 data.unshift({
                     name: obj.sm_name,
                     url: obj.sm_url
                 });
                 window.localStorage.setItem("storage_managers", JSON.stringify(data));
                 obj.storage_managers = data;
                 obj.sm_name = "";
                 obj.sm_url = "";
                 obj.show_add_storage_manager = false;
                 obj.message = "Storage Manager added successfully!";
                 obj.show_add_button = true;
                 setTimeout(function() {
                     obj.message = "";
                 }, 5000);
             },
             deleteInstance(sm_name) {
                 if (!confirm(`Are you sure want to delete ${sm_name}?`)) {
                     return;
                 }
                 var instances = window.localStorage.getItem("storage_managers");
                 if (!instances) return;

                 this.storage_managers = JSON.parse(instances).filter(function(value, index, arr){
                     return value.name != sm_name;
                 });
                 window.localStorage.setItem("storage_managers", JSON.stringify(this.storage_managers));
                 if (this.storage_managers.length === 0) {
                     this.show_add_button = false;
                 }
             }
         }))
     })
    </script>

          </div>
      </div>
  </body>
</html>